---
title: "Modeling Workspace"
author: "William Morgan"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: pdf_document
---

```{r setup, include=FALSE}
rm(list = ls())

set.seed(123)
knitr::opts_chunk$set(echo = FALSE, fig.align = 'center', eval = FALSE)
libs <- c('readxl', 'tidyverse', 'data.table', 'glmnet', 'caret', 'broom')
lapply(libs, library, character.only = TRUE)
```

## __Problem Outline__

What do we want to answer?

- _Q1:_ Does faculty activity on discussion forums affect student engagement on forums?

- _Q2:_ Are grade outcomes affected by the level and timing of faculty activity 
in discussion forums?

- _Q3:_ Do course evaluation scores fluctuate with the level of activity in a discussion
forum?

***

## __Research Question 1__
Based on the available data, we can use two metrics for student behavior on
discussion forums:

- number of posts per student over the entire course

- consistency of student posts from week to week

  - variance of the number of posts from week to week

```{r}
## Import data and select columns
source("Code/Sample Selection.R", local = TRUE)

forum %<>% select(avg_fac_post_len, enrl_total, fac_post_consistency,
                  has_hallway, posts_per_fac, posts_per_student, prop_posts_boc,
                  session_a, stu_post_consistency, upper_division)


## Standardize predictors
X <- select(forum, -stu_post_consistency) %>%
  model.matrix(posts_per_student ~ (.)-1, data = .)
  
Y <- forum$posts_per_student %>%
  unlist()

pps_mod <- cv.glmnet(X, Y, intercept = FALSE, alpha = 0)

tidy(coef(pps_mod, s = 'lambda.1se'))
```

```{r rq1 sample}
## Import data and select columns
source("Code/Sample Selection.R", local = TRUE)

forum %<>% select(avg_fac_post_len, enrl_total, fac_post_consistency,
                  has_hallway, posts_per_fac, posts_per_student, prop_posts_boc,
                  session_a, stu_post_consistency, upper_division)


## Standardize predictors
X <- select(forum , -posts_per_student, -stu_post_consistency) %>%
  data.matrix()

std_vals <- preProcess(X, method = c("center", "scale"))

# X <- predict(std_vals, X) %>%
#   data.matrix()

## Define model matrices for each model
pps <- select(forum, posts_per_student) %>%
  data.matrix()

stu_cons <- select(forum, stu_post_consistency) %>%
  data.matrix()

## Define lambda sequence for testing
lambda <-  exp(seq(log(.000001), log(1000), length.out = 250))

## Run Models
pps_mod <- cv.glmnet(X, pps,
       family = 'gaussian',
       standardize = TRUE,
       lambda = lambda)


cons_mod <- cv.glmnet(X, stu_cons,
                      family = 'gaussian',
                      standardize = TRUE,
                      lambda = lambda)

## Print results
print("Lasso Estimates of Posts per Student Model")
tidy(coef(pps_mod, s = 'lambda.min')) %>%
  select(-column)

print("Lasso Estimates of Student Post Consistency Model")
tidy(coef(cons_mod, s = 'lambda.min')) %>%
  select(-column)

```

Because we are unable to directly get at the standard errors and p-values 
for the lasso estimates, we use these results to inform a second model; just a 
standard linear model.

```{r rq1 lin mods}
# change model data to df for glm()
pps <- select(forum,-stu_post_consistency)
cons <- select(forum, -posts_per_student, -prop_posts_eoc)

pps_mod2 <- glm(posts_per_student ~ ., pps, family = 'gaussian') %>%
  tidy() %>%
  select(-statistic)

cons_mod2 <- glm(stu_post_consistency ~ ., cons, family = 'gaussian') %>%
  tidy() %>%
  select(-statistic)

print("Coefficient estimates from linear model with response: Posts per Student")
pps_mod2

print("Coefficient estimates from linear model with response: Student Post Consistency")
cons_mod2
```

***

## __Research Question 2:__

How do student outcomes change with the level of engagement in online forums?
If there is a change, it is independent of who is doing the posting?

keep it simple; just use pass_rate and avg_gpa


```{r rq2 sample}
source("Code/Sample Selection.R", local = TRUE)

forum  <- forum %>%
  select(-course_id, -wdrw_rate, -instr_score, -design_score)

X <-  select(forum, -avg_gpa, -pass_rate)

std_vals <- preProcess(X, method = c("center", "scale"))

X <- predict(std_vals, X) %>%
  data.matrix()

gpa <- select(forum, avg_gpa) %>%
  data.matrix()

gpa_mod <- cv.glmnet(X, gpa,
                     family = 'gaussian',
                     standardize = FALSE,
                     lambda = lambda)

print("Lasso estimates of GPA model")
tidy(coef(gpa_mod, s = 'lambda.min')) %>%
  select(-column)
```

We repeat the same procedure from the previous research question to get more
interpretable results. 

```{r rq2 lin mods}
gpa <- select(forum, -pass_rate)

gpa_mod2 <- glm(avg_gpa ~ ., gpa, family = 'gaussian') %>%
  tidy() %>%
  select(-statistic)

print("Coefficient Estimates for linear GPA model: ")
gpa_mod2

```

I don't exactly understand how to interpret the coefficients of `prop_posts_boc`
and `prop_posts_eoc` when they are included in the same model, so it is worth running
the model two more times using one variable at a time. The reason I think this is
difficult to understand is because the two aren't entirely but pretty strongly
dependent on one another. I didn't think this was a problem when I was looking
at the correlation matrix, but now that the models are ran I realize this is kind
of wonky.

```{r rq2 eoc boc mods}
gpa <- select(forum, -pass_rate, -prop_posts_eoc)

gpa_mod_boc <- glm(avg_gpa ~ ., gpa, family = 'gaussian') %>%
  tidy() %>%
  select(-statistic)

print("Coefficient Estimates for linear GPA model with only `prop_posts_boc`: ")
gpa_mod_boc

gpa <- select(forum, -pass_rate, -prop_posts_boc)

gpa_mod_eoc <- glm(avg_gpa ~ ., gpa, family = 'gaussian') %>%
  tidy() %>%
  select(-statistic)

print("Coefficient Estimates for linear GPA model with only `prop_posts_eoc`: ")
gpa_mod_eoc

```


***


## __Future Options__

- can we add data about instructors making announcements?

- what peoplesoft data can be used?


***

## __Working Notes__

- research questions should be reordered; train of thought should be:

  - does faculty activity on forums affect grade outcomes?
  
    - what characteristics of faculty activity have greatest effect? (early
    course posts, late course posts, consistency of posting)

  - does faculty activity on forums affect student activity on forums?
  
    - what student activity do we want to measure?
    
***










