---
title: "Modeling Workspace"
author: "William Morgan"
date: "February 26, 2018"
output: pdf_document
---

```{r setup, include=FALSE}
rm(list = ls())
knitr::opts_chunk$set(echo = TRUE, fig.align = 'center', fig.dim = c(3.5,3.5))

libs <- c('readxl', 'tidyverse', 'data.table', 'glmnet')
lapply(libs, library, character.only = TRUE)
```

## __Basic Outline__
Dependent variables we might be interested in:

  - passing rate (`pass_rate`)
  
  - section average gpa (`avg_gpa`)
  
Independent variables we might be interested in:

  - proportion of students that posted (`prop_stu_posted`)
  
  - instructor and course design review scores (`inst_score`, `design_score`)
  
  - number of posts per student (`posts_per_student`)
  
  - number of posts per faculty (`posts_per_fac` - might be skewed by courses with
  many TAs that never post)
  
  - class size (`enrl_total`)
  
  - having hallway discussion (`has_hallway`)
  
  - indicator for posting in a particular week (`fac_posted_wk*`)
  
  - average length of faculty posts (`avg_fac_post_len`)
  
  - whether the course is upper division (`upper_division`)
  

Alright let's just get to it already

```{r}
forum <- read_csv("Data/forum_cleaned.csv", col_types = cols())

avg_gpa <- mean(forum$avg_gpa)

forum <- forum %>%
  mutate_at(vars(strm, session_code, has_hallway, fac_posted_boc,
                 fac_posted_eoc, upper_division), as.factor)

# Define model data for model estimating average gpa
gpaX <- model.matrix(avg_gpa ~ prop_stu_posted + instr_score + design_score
                               + posts_per_student + posts_per_fac + enrl_total
                               + has_hallway + fac_posted_boc + fac_posted_eoc
                               + avg_fac_post_len + upper_division, data = forum)[, -1]

# Define vector of outputs
gpaY <- forum$avg_gpa

# Set up CV'd Lasso
gpa_fit <- cv.glmnet(gpaX, gpaY, family = 'gaussian', alpha = 1)

coef(gpa_fit, s = 'lambda.min')
```


```{r correlation graph}
reshape2::melt(round(cor(gpaX), 2)) %>%
  ggplot(aes(Var1, Var2, fill = value)) +
  geom_tile() +
  theme(axis.text.x = element_text(angle = 60, vjust = .75))

ggsave('Graphics/gpaX correlation.png')
```


```{r ovall pass rate}
passX <- model.matrix(pass_rate ~ prop_stu_posted + instr_score + design_score
                               + posts_per_student + posts_per_fac + enrl_total
                               + has_hallway + fac_posted_boc + fac_posted_eoc
                               + avg_fac_post_len + upper_division, data = forum)[, -1]
passY <- forum$pass_rate

pass_fit <- cv.glmnet(passX, passY, family = 'gaussian', alpha = 1)

coef(pass_fit, s = 'lambda.min')


```
